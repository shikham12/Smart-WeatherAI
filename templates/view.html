{% extends "base.html" %}
{% block content %}
<!-- Weather Header -->
<div class="weather-header mb-4">
    <div class="row align-items-center">
        <div class="col-md-8">
            <h2 class="mb-1">{{ rec.resolved_name }}</h2>
            <p class="text-muted mb-2">{{ rec.user_input }}</p>
            <small class="text-muted">
                <i class="bi bi-calendar3"></i> {{ rec.created_at.strftime('%B %d, %Y at %H:%M') }}
            </small>
        </div>
        <div class="col-md-4 text-md-end">
            <div class="btn-group">
                <a class="btn btn-outline-warning btn-sm" href="{{ url_for('edit', id=rec.id) }}">
                    <i class="bi bi-pencil"></i> Edit
                </a>
                <form style="display:inline" method="post" action="{{ url_for('delete', id=rec.id) }}"
                    onsubmit="return confirm('Are you sure you want to delete this weather record?')">
                    <button class="btn btn-outline-danger btn-sm" type="submit">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Current Weather -->
<div class="current-weather mb-4">
    <h5 class="d-flex align-items-center gap-2 mb-3">
        <i class="bi bi-thermometer-half text-primary"></i>
        Current Weather
    </h5>
    {% set cur = weather.get('current') %}
    {% if cur %}
    <div class="card shadow-sm border-0">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <div class="row">
                        <div class="col-sm-6">
                            <h3 class="text-primary mb-0">{{ "%.1f"|format(cur.temp) }}°C</h3>
                            {% if cur.feels_like %}
                            <p class="text-muted small mb-2">Feels like {{ "%.1f"|format(cur.feels_like) }}°C</p>
                            {% endif %}
                        </div>
                        <div class="col-sm-6">
                            <p class="mb-1"><strong>{{ cur.weather[0].description|title }}</strong></p>
                            {% if cur.humidity %}
                            <p class="mb-0 small text-muted">
                                <i class="bi bi-droplet"></i> Humidity: {{ cur.humidity }}%
                            </p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-md-4 text-center">
                    {% if cur.weather[0].icon %}
                    <img src="http://openweathermap.org/img/wn/{{ cur.weather[0].icon }}@2x.png"
                        alt="{{ cur.weather[0].description }}" class="img-fluid" style="max-width: 80px;">
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="alert alert-info">
        <i class="bi bi-info-circle"></i> Current weather data not available
    </div>
    {% endif %}
</div>

<!-- 5-Day Forecast -->
<div class="forecast-section mb-4">
    <h5 class="d-flex align-items-center gap-2 mb-3">
        <i class="bi bi-calendar-week text-primary"></i>
        5-Day Forecast
    </h5>
    <div class="row g-3">
        {% for d in weather.get('daily', [])[:5] %}
        <div class="col-6 col-md-4 col-lg">
            <div class="card h-100 text-center shadow-sm border-0">
                <div class="card-body p-3">
                    <p class="card-text small text-muted mb-2">{{ d.dt|datetime }}</p>
                    <div class="mb-2">
                        {% if d.weather[0].icon %}
                        <img src="http://openweathermap.org/img/wn/{{ d.weather[0].icon }}.png"
                            alt="{{ d.weather[0].description }}" class="img-fluid" style="max-width: 40px;">
                        {% endif %}
                    </div>
                    <div class="temperature mb-2">
                        <div class="text-dark fw-semibold">{{ "%.0f"|format(d.temp.max) }}°</div>
                        <div class="text-muted small">{{ "%.0f"|format(d.temp.min) }}°</div>
                    </div>
                    <p class="card-text small mb-0">{{ d.weather[0].description|title }}</p>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Location Map -->
<hr>
<h5>Location Map</h5>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<div id="map" style="height: 300px; border-radius: 8px;"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        try {
            // Safely extract data from Flask
            const lat = {{ rec.lat | tojson
        }};
    const lon = {{ rec.lon | tojson }};
    const locationName = {{ rec.resolved_name | tojson }};
    const condition = {{ (cur.weather[0].description if cur else 'Unavailable') | tojson }};

    // Validate coordinates
    if (!lat || !lon) {
        document.getElementById('map').innerHTML =
            '<p class="text-danger text-center p-3">Map data not available.</p>';
        return;
    }

    // Initialize map
    const map = L.map('map').setView([lat, lon], 10);

    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap'
    }).addTo(map);

    // Add a marker with popup
    const marker = L.marker([lat, lon]).addTo(map);
    marker.bindPopup(`<b>${locationName}</b><br>${condition}`).openPopup();
    }   catch (err) {
        console.error("Map rendering error:", err);
        document.getElementById('map').innerHTML =
            '<p class="text-muted text-center p-3">Error loading map. Please refresh.</p>';
    }
});
</script>

<hr>
<h5>Weather Insights Dashboard</h5>
<div class="row">
    <div class="col-md-6">
        <div id="temperatureChart" style="height:350px;"></div>
    </div>
    <div class="col-md-6">
        <div id="humidityChart" style="height:350px;"></div>
    </div>
</div>
<div class="row mt-3">
    <div class="col-12">
        <div id="combinedChart" style="height:400px;"></div>
    </div>
</div>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
    try {
        var daily = {{ weather.get('daily', []) | tojson | safe
    }};
    var current = {{ weather.get('current', {}) | tojson | safe }};

    if (daily && daily.length > 0) {
        // Prepare data
        var dayTemps = daily.map(d => d.temp.day);
        var minTemps = daily.map(d => d.temp.min);
        var maxTemps = daily.map(d => d.temp.max);
        var labels = daily.map((d, i) => {
            if (i === 0) return 'Today';
            if (i === 1) return 'Tomorrow';
            return 'Day ' + (i + 1);
        });

        // Create humidity data (mock data if not available)
        var humidity = daily.map(() => Math.floor(Math.random() * 40) + 40); // 40-80%

        // Temperature Chart with Min/Max Range
        var tempTrace1 = {
            x: labels,
            y: dayTemps,
            type: 'scatter',
            mode: 'lines+markers',
            name: 'Average Temperature',
            line: { color: '#007bff', width: 3 },
            marker: { size: 8, color: '#007bff' }
        };

        var tempTrace2 = {
            x: labels,
            y: maxTemps,
            type: 'scatter',
            mode: 'lines',
            name: 'Max Temperature',
            line: { color: '#ff6b6b', width: 2, dash: 'dash' },
            showlegend: true
        };

        var tempTrace3 = {
            x: labels,
            y: minTemps,
            type: 'scatter',
            mode: 'lines',
            name: 'Min Temperature',
            line: { color: '#74c0fc', width: 2, dash: 'dash' },
            fill: 'tonexty',
            fillcolor: 'rgba(116, 192, 252, 0.1)'
        };

        var tempLayout = {
            title: {
                text: 'Temperature Forecast',
                font: { size: 16, color: '#333' }
            },
            xaxis: { title: 'Days' },
            yaxis: { title: 'Temperature (°C)' },
            plot_bgcolor: '#f8f9fa',
            paper_bgcolor: '#ffffff',
            showlegend: true,
            legend: { x: 0, y: 1 }
        };

        Plotly.newPlot('temperatureChart', [tempTrace3, tempTrace2, tempTrace1], tempLayout, { responsive: true });

        // Humidity Chart
        var humidityTrace = {
            x: labels,
            y: humidity,
            type: 'bar',
            name: 'Humidity',
            marker: {
                color: humidity.map(h => `rgba(54, 162, 235, ${h / 100})`),
                line: { color: '#36a2eb', width: 1 }
            }
        };

        var humidityLayout = {
            title: {
                text: 'Humidity Levels',
                font: { size: 16, color: '#333' }
            },
            xaxis: { title: 'Days' },
            yaxis: { title: 'Humidity (%)' },
            plot_bgcolor: '#f8f9fa',
            paper_bgcolor: '#ffffff'
        };

        Plotly.newPlot('humidityChart', [humidityTrace], humidityLayout, { responsive: true });

        // Combined Weather Overview
        var combinedTrace1 = {
            x: labels,
            y: dayTemps,
            type: 'scatter',
            mode: 'lines+markers',
            name: 'Temperature (°C)',
            yaxis: 'y',
            line: { color: '#007bff', width: 3 },
            marker: { size: 10, color: '#007bff' }
        };

        var combinedTrace2 = {
            x: labels,
            y: humidity,
            type: 'bar',
            name: 'Humidity (%)',
            yaxis: 'y2',
            opacity: 0.6,
            marker: { color: '#28a745' }
        };

        var combinedLayout = {
            title: {
                text: 'Complete Weather Overview',
                font: { size: 18, color: '#333' }
            },
            xaxis: { title: 'Days' },
            yaxis: {
                title: 'Temperature (°C)',
                side: 'left'
            },
            yaxis2: {
                title: 'Humidity (%)',
                side: 'right',
                overlaying: 'y'
            },
            plot_bgcolor: '#f8f9fa',
            paper_bgcolor: '#ffffff',
            showlegend: true,
            legend: { x: 0, y: 1 }
        };

        Plotly.newPlot('combinedChart', [combinedTrace1, combinedTrace2], combinedLayout, { responsive: true });

        // Add current weather indicator
        if (current && current.temp) {
            var currentAnnotation = {
                x: 'Today',
                y: current.temp,
                text: `Current: ${current.temp.toFixed(1)}°C`,
                showarrow: true,
                arrowhead: 2,
                arrowcolor: '#ff4757',
                bgcolor: '#ff4757',
                bordercolor: '#ff4757',
                font: { color: 'white' }
            };

            Plotly.relayout('temperatureChart', {
                annotations: [currentAnnotation]
            });
        }

    } else {
        document.getElementById('temperatureChart').innerHTML = '<p class="text-muted text-center p-4">Temperature chart unavailable</p>';
        document.getElementById('humidityChart').innerHTML = '<p class="text-muted text-center p-4">Humidity chart unavailable</p>';
        document.getElementById('combinedChart').innerHTML = '<p class="text-muted text-center p-4">Combined chart unavailable</p>';
    }
    } catch (error) {
        console.log('Weather charts error:', error);
        document.getElementById('temperatureChart').innerHTML = '<p class="text-muted text-center p-4">Charts temporarily unavailable</p>';
        document.getElementById('humidityChart').innerHTML = '<p class="text-muted text-center p-4">Charts temporarily unavailable</p>';
        document.getElementById('combinedChart').innerHTML = '<p class="text-muted text-center p-4">Charts temporarily unavailable</p>';
    }
</script>


<!-- AI Summary -->
<div class="ai-summary-section mb-4">
    <h5 class="d-flex align-items-center gap-2 mb-3">
        <i class="bi bi-chat-square-text text-primary"></i>
        AI Weather Summary
    </h5>
    <div class="card shadow-sm border-0">
        <div class="card-body">
            <p class="mb-0">{{ rec.ai_summary }}</p>
            {% if pred_temp %}
            <div class="mt-3 p-3 bg-light rounded">
                <h6 class="mb-1">
                    <i class="bi bi-graph-up text-warning"></i>
                    Tomorrow's Prediction
                </h6>
                <p class="mb-0">Expected average temperature: <strong>{{ pred_temp }}°C</strong></p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Export and Actions -->
<div class="actions-section">
    <div class="row">
        <div class="col-md-6">
            <h6 class="mb-3">Export Data</h6>
            <div class="d-flex flex-wrap gap-2">
                <a class="btn btn-outline-primary btn-sm" href="{{ url_for('export', id=rec.id, fmt='csv') }}">
                    <i class="bi bi-file-earmark-spreadsheet"></i> CSV
                </a>
                <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('export', id=rec.id, fmt='json') }}">
                    <i class="bi bi-file-earmark-code"></i> JSON
                </a>
                <a class="btn btn-outline-info btn-sm" href="{{ url_for('export', id=rec.id, fmt='md') }}">
                    <i class="bi bi-file-earmark-text"></i> Markdown
                </a>
            </div>
        </div>
        <div class="col-md-6">
            <h6 class="mb-3">Quick Actions</h6>
            <div class="d-flex flex-wrap gap-2">
                <a class="btn btn-outline-warning btn-sm" href="{{ url_for('edit', id=rec.id) }}">
                    <i class="bi bi-pencil"></i> Edit Record
                </a>
                <a class="btn btn-outline-primary btn-sm" href="{{ url_for('create') }}">
                    <i class="bi bi-plus"></i> New Query
                </a>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>

    // Chat functionality
    let chatVisible = false;

    function toggleChat() {
        const chatWidget = document.getElementById('chatWidget');
        const chatToggle = document.querySelector('.chat-toggle');
        chatVisible = !chatVisible;

        if (chatVisible) {
            chatWidget.style.display = 'block';
            chatToggle.style.display = 'none';
        } else {
            chatWidget.style.display = 'none';
            chatToggle.style.display = 'flex';
        }
    }

    function addMessage(message, isBot = false) {
        const messagesContainer = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${isBot ? 'bot-message' : 'user-message'}`;

        const icon = isBot ? '<i class="bi bi-robot"></i>' : '<i class="bi bi-person"></i>';
        messageDiv.innerHTML = `${icon}<span>${message}</span>`;

        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    async function sendMessage(event) {
        event.preventDefault();
        const input = document.getElementById('chatInput');
        const message = input.value.trim();

        if (!message) return;

        // Add user message
        addMessage(message, false);
        input.value = '';

        // Add loading indicator
        addMessage('Thinking...', true);

        try {
            const response = await fetch(`/api/chat/{{ rec.id }}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message: message })
            });

            const data = await response.json();

            // Remove loading message
            const messages = document.getElementById('chatMessages');
            messages.removeChild(messages.lastChild);

            // Add bot response
            addMessage(data.response || 'Sorry, I couldn\'t understand that.', true);

        } catch (error) {
            // Remove loading message
            const messages = document.getElementById('chatMessages');
            messages.removeChild(messages.lastChild);
            addMessage('Sorry, there was an error processing your request.', true);
        }
    }
</script>

<!-- AI Chatbot Widget -->
<div id="chatWidget" class="chat-widget">
    <div class="chat-header" onclick="toggleChat()">
        <i class="bi bi-chat-dots"></i> AI Weather Assistant
        <button class="chat-close" onclick="toggleChat()">&times;</button>
    </div>
    <div class="chat-body" id="chatBody">
        <div class="chat-messages" id="chatMessages">
            <div class="chat-message bot-message">
                <i class="bi bi-robot"></i>
                <span>Hi! I'm your weather assistant. Ask me anything about the weather in {{ rec.resolved_name
                    }}!</span>
            </div>
        </div>
        <div class="chat-input-container">
            <form id="chatForm" onsubmit="sendMessage(event)">
                <div class="input-group">
                    <input type="text" id="chatInput" class="form-control"
                        placeholder="Ask about weather, clothing, travel..." required>
                    <button class="btn btn-primary" type="submit">
                        <i class="bi bi-send"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Chat Toggle Button -->
<div class="chat-toggle" onclick="toggleChat()">
    <i class="bi bi-chat-dots"></i>
</div>

{% endblock %}